var Leaf=class{constructor(trie){this.children=[];this.parent=trie}delete(value){const index=this.children.indexOf(value);if(index===-1)return false;this.children=this.children.slice(0,index).concat(this.children.slice(index+1));if(this.children.length===0){this.parent.delete(this)}return true}add(value){this.children.push(value);return this}};var RadixTrie=class{constructor(trie){this.parent=null;this.children={};this.parent=trie||null}get(edge){return this.children[edge]}insert(edges){let currentNode=this;for(let i=0;i<edges.length;i+=1){const edge=edges[i];let nextNode=currentNode.get(edge);if(i===edges.length-1){if(nextNode instanceof RadixTrie){currentNode.delete(nextNode);nextNode=null}if(!nextNode){nextNode=new Leaf(currentNode);currentNode.children[edge]=nextNode}return nextNode}else{if(nextNode instanceof Leaf)nextNode=null;if(!nextNode){nextNode=new RadixTrie(currentNode);currentNode.children[edge]=nextNode}}currentNode=nextNode}return currentNode}delete(node){for(const edge in this.children){const currentNode=this.children[edge];if(currentNode===node){const success=delete this.children[edge];if(Object.keys(this.children).length===0&&this.parent){this.parent.delete(this)}return success}}return false}};function isFormField(element){if(!(element instanceof HTMLElement)){return false}const name=element.nodeName.toLowerCase();const type=(element.getAttribute("type")||"").toLowerCase();return name==="select"||name==="textarea"||name==="input"&&type!=="submit"&&type!=="reset"&&type!=="checkbox"&&type!=="radio"||element.isContentEditable}function fireDeterminedAction(el,path2){const delegateEvent=new CustomEvent("hotkey-fire",{cancelable:true,detail:{path:path2}});const cancelled=!el.dispatchEvent(delegateEvent);if(cancelled)return;if(isFormField(el)){el.focus()}else{el.click()}}function expandHotkeyToEdges(hotkey2){return hotkey2.split(",").map(edge=>edge.split(" "))}function hotkey(event){const elideShift=event.code.startsWith("Key")&&event.shiftKey&&event.key.toUpperCase()===event.key;return`${event.ctrlKey?"Control+":""}${event.altKey?"Alt+":""}${event.metaKey?"Meta+":""}${event.shiftKey&&!elideShift?"Shift+":""}${event.key}`}var hotkeyRadixTrie=new RadixTrie;var elementsLeaves=new WeakMap;var currentTriePosition=hotkeyRadixTrie;var resetTriePositionTimer=null;var path=[];function resetTriePosition(){path=[];resetTriePositionTimer=null;currentTriePosition=hotkeyRadixTrie}function keyDownHandler(event){if(event.defaultPrevented)return;if(!(event.target instanceof Node))return;if(isFormField(event.target)){const target=event.target;if(!target.id)return;if(!target.ownerDocument.querySelector(`[data-hotkey-scope="${target.id}"]`))return}if(resetTriePositionTimer!=null){window.clearTimeout(resetTriePositionTimer)}resetTriePositionTimer=window.setTimeout(resetTriePosition,1500);const newTriePosition=currentTriePosition.get(hotkey(event));if(!newTriePosition){resetTriePosition();return}path.push(hotkey(event));currentTriePosition=newTriePosition;if(newTriePosition instanceof Leaf){const target=event.target;let shouldFire=false;let elementToFire;const formField=isFormField(target);for(let i=newTriePosition.children.length-1;i>=0;i-=1){elementToFire=newTriePosition.children[i];const scope=elementToFire.getAttribute("data-hotkey-scope");if(!formField&&!scope||formField&&target.id===scope){shouldFire=true;break}}if(elementToFire&&shouldFire){fireDeterminedAction(elementToFire,path);event.preventDefault()}resetTriePosition()}}function install(element,hotkey2){if(Object.keys(hotkeyRadixTrie.children).length===0){document.addEventListener("keydown",keyDownHandler)}const hotkeys=expandHotkeyToEdges(hotkey2||element.getAttribute("data-hotkey")||"");const leaves=hotkeys.map(h=>hotkeyRadixTrie.insert(h).add(element));elementsLeaves.set(element,leaves)}function uninstall(element){const leaves=elementsLeaves.get(element);if(leaves&&leaves.length){for(const leaf of leaves){leaf&&leaf.delete(element)}}if(Object.keys(hotkeyRadixTrie.children).length===0){document.removeEventListener("keydown",keyDownHandler)}}export{install,uninstall};
